<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLEEs Value List</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- GLOBAL & VARIABLES --- */
        :root { 
            --bg-app: #050508; /* Darker background */
            --bg-card: rgba(25, 25, 35, 0.6); /* Glassy Card */
            --bg-sidebar: #08080b;
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --text-main: #ffffff;
            --text-muted: #a0a0b0;
            
            --rarity-secret: #ff0055;
            --rarity-mythical: #d500f9;
            --rarity-legendary: #ffd600;
            
            --market-color: #00d4ff;
            --danger: #ff4757;
            --success: #2ed573;
            --premium: #ffa502;
            --dead: #7e22ce;
            
            --transition-fast: 0.2s ease;
            --transition-smooth: 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 15px rgba(0, 212, 255, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; scrollbar-width: thin; scrollbar-color: #333 transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        body { background-color: var(--bg-app); color: var(--text-main); overflow: hidden; -webkit-font-smoothing: antialiased; }

        /* --- DESKTOP UI --- */
        .desktop-view { display: none; height: 100vh; width: 100vw; flex-direction: row; overflow: hidden; }
        @media (min-width: 901px) { .desktop-view { display: flex; } }

        /* Sidebar */
        .d-sidebar {
            width: 280px; background: var(--bg-sidebar);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            border-right: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            z-index: 2;
        }
        .d-sb-header { margin-bottom: 10px; }
        .d-title { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; display: block; margin-bottom: 5px; background: linear-gradient(45deg, var(--market-color), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .d-badge { font-size: 0.6rem; background: rgba(46, 213, 115, 0.1); color: var(--success); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(46, 213, 115, 0.3); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; display: inline-block; }
        
        .d-discord { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: #5865F2; color: white; text-decoration: none; 
            padding: 10px; border-radius: 8px; font-weight: 700; font-size: 0.85rem;
            transition: var(--transition-fast); box-shadow: 0 4px 10px rgba(88, 101, 242, 0.3);
        }
        .d-discord:hover { transform: translateY(-2px); background: #4752c4; }

        .d-status { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid var(--glass-border); }
        .d-status-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; color: var(--text-muted); }
        .d-status-row span:last-child { color: var(--text-main); font-weight: 600; font-family: monospace; }
        .d-premium { color: var(--premium); display: none; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; margin-left: 5px; }

        .d-key-btn { 
            background: transparent; border: 1px solid var(--market-color); color: var(--market-color);
            padding: 10px; border-radius: 8px; font-weight: 700; cursor: pointer;
            transition: var(--transition-fast); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;
        }
        .d-key-btn:hover { background: var(--market-color); color: #000; box-shadow: 0 0 15px rgba(0, 212, 255, 0.4); }

        .d-help { font-size: 0.7rem; line-height: 1.6; color: var(--text-muted); background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px dashed var(--glass-border); }
        .d-help b { color: var(--text-main); }

        .d-egg-list { list-style: none; overflow-y: auto; flex: 1; margin-top: 10px; padding-right: 5px; }
        .d-egg-item { 
            padding: 10px 12px; margin-bottom: 6px; background: rgba(255,255,255,0.02); 
            border-radius: 6px; cursor: pointer; transition: var(--transition-fast); 
            border-left: 2px solid transparent; font-size: 0.85rem; color: var(--text-muted);
        }
        .d-egg-item:hover { background: rgba(255,255,255,0.06); color: var(--text-main); transform: translateX(4px); }
        .d-egg-item.active { background: rgba(0, 212, 255, 0.1); color: var(--market-color); border-left-color: var(--market-color); }

        /* Main Content */
        .d-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: radial-gradient(circle at top right, rgba(0, 212, 255, 0.05), transparent 40%); }
        
        .d-top-bar { 
            padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(5, 5, 8, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border);
            z-index: 5;
        }
        .d-tabs { display: flex; background: rgba(255,255,255,0.03); padding: 4px; border-radius: 10px; gap: 4px; }
        .d-tab { 
            padding: 8px 16px; border: none; background: transparent; color: var(--text-muted); 
            cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 0.85rem; 
            transition: var(--transition-fast); 
        }
        .d-tab:hover { color: white; background: rgba(255,255,255,0.05); }
        .d-tab.active { background: rgba(255,255,255,0.1); color: white; box-shadow: inset 0 1px 2px rgba(0,0,0,0.2); }

        .d-controls { display: flex; gap: 10px; align-items: center; }
        .d-input { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; 
            padding: 8px 12px; border-radius: 8px; outline: none; font-size: 0.85rem; height: 36px;
            transition: var(--transition-fast); width: 140px;
        }
        .d-input:focus { border-color: var(--market-color); background: rgba(255,255,255,0.08); }
        
        .d-btn { 
            background: linear-gradient(135deg, var(--market-color), #0099cc); color: #000; 
            padding: 0 18px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; 
            font-size: 0.85rem; height: 36px; white-space: nowrap; transition: var(--transition-fast); 
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
        }
        .d-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0, 212, 255, 0.35); filter: brightness(1.1); }
        .d-btn:active { transform: translateY(1px); }

        .d-filter-bar { 
            padding: 10px 25px; display: none; gap: 10px; flex-wrap: wrap; 
            background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border); align-items: center;
        }
        .d-filter-bar.visible { display: flex; }
        
        .d-filter-btn { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); 
            color: var(--text-muted); padding: 6px 10px; border-radius: 6px; font-size: 0.7rem; 
            font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
            transition: var(--transition-fast);
        }
        .d-filter-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .d-filter-btn.active { background: rgba(255,255,255,0.15); color: white; border-color: rgba(255,255,255,0.3); transform: scale(1.05); }

        .d-content { flex: 1; overflow-y: auto; padding: 25px; position: relative; }
        .d-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }

        /* --- CARDS --- */
        .d-card, .m-card { 
            background: var(--bg-card); border-radius: 12px; padding: 15px; border: 1px solid var(--glass-border);
            transition: var(--transition-smooth); position: relative; overflow: hidden;
            box-shadow: var(--shadow-card);
        }
        .d-card::before, .m-card::before {
            content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.03), transparent);
            opacity: 0; transition: var(--transition-smooth); pointer-events: none;
        }
        
        .d-card:hover { 
            transform: translateY(-5px) scale(1.01); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), var(--shadow-glow); 
            border-color: rgba(255,255,255,0.15);
        }
        .d-card:hover::before { opacity: 1; }

        /* Rarity Indicator (Left Border) */
        .d-card::after, .m-card::after {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #333; border-radius: 12px 0 0 12px;
            transition: var(--transition-fast);
        }
        .d-card.rarity-Secret::after, .m-card[data-rarity="Secret"]::after { background: var(--rarity-secret); box-shadow: 0 0 8px var(--rarity-secret); }
        .d-card.rarity-Mythical::after, .m-card[data-rarity="Mythical"]::after { background: var(--rarity-mythical); box-shadow: 0 0 8px var(--rarity-mythical); }
        .d-card.rarity-Legendary::after, .m-card[data-rarity="Legendary"]::after { background: var(--rarity-legendary); box-shadow: 0 0 8px var(--rarity-legendary); }

        /* Card Content */
        .d-card-header, .m-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .d-card-header span:first-child, .m-card-header span:first-child { font-weight: 700; font-size: 1rem; color: #fff; }
        .d-card-badge, .m-card-badge { font-size: 0.6rem; background: rgba(255,255,255,0.1); padding: 3px 6px; border-radius: 4px; color: #ccc; text-transform: uppercase; font-weight: 700; }

        /* 3 Column Prices (Desktop) */
        .d-price-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: auto; }
        .d-price-box { 
            background: rgba(0,0,0,0.3); padding: 8px 4px; border-radius: 6px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 2px;
            transition: var(--transition-fast);
        }
        .d-price-box:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); }
        .d-price-label { font-size: 0.45rem; color: #888; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .d-price-val { font-family: 'Courier New', monospace; font-size: 0.95rem; color: #fff; font-weight: 700; }

        .d-demand { text-align: center; padding: 4px; border-radius: 4px; font-weight: 700; font-size: 0.65rem; text-transform: uppercase; margin-top: 6px; letter-spacing: 1px; opacity: 0.9; }
        .d-demand.High { background: rgba(46, 213, 115, 0.15); color: var(--success); border: 1px solid rgba(46, 213, 115, 0.3); }
        .d-demand.Medium { background: rgba(255, 165, 2, 0.15); color: var(--premium); border: 1px solid rgba(255, 165, 2, 0.3); }
        .d-demand.Low { background: rgba(255, 71, 87, 0.15); color: var(--danger); border: 1px solid rgba(255, 71, 87, 0.3); }

        /* Market Cards (Desktop) */
        .d-mkt-card { min-height: 220px; }
        .d-mkt-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 8px 0; }
        .d-mkt-stat { background: rgba(0,0,0,0.3); padding: 6px; border-radius: 6px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .d-mkt-stat span { font-size: 0.5rem; color: #888; text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 2px; }
        .d-mkt-stat strong { font-size: 0.9rem; font-family: monospace; color: #fff; }
        .d-mkt-stat.price strong { color: var(--market-color); text-shadow: 0 0 5px rgba(0,212,255,0.4); }
        
        .d-mkt-footer { display: grid; grid-template-columns: 1fr auto; gap: 6px; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
        .d-seller { font-size: 0.75rem; font-family: monospace; color: var(--market-color); background: rgba(0,212,255,0.05); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(0,212,255,0.1); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .d-acts { display: flex; gap: 4px; }
        .d-act-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #ddd; 
            padding: 5px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; cursor: pointer; 
            transition: var(--transition-fast); text-transform: uppercase;
        }
        .d-act-btn:hover { background: rgba(255,255,255,0.15); color: white; }
        .d-act-del { color: var(--danger); border-color: rgba(255, 71, 87, 0.3); background: rgba(255, 71, 87, 0.05); }
        .d-act-del:hover { background: var(--danger); color: white; transform: scale(1.05); }
        
        .d-timer { font-size: 0.6rem; color: #666; text-align: right; margin-top: 2px; grid-column: 1 / -1; font-family: monospace; }
        .d-neg { grid-column: 1 / -1; text-align: center; font-size: 0.65rem; color: var(--premium); font-weight: 700; background: rgba(255, 165, 2, 0.1); border-radius: 4px; padding: 2px; }

        /* --- MOBILE UI --- */
        .mobile-view { display: none; flex-direction: column; height: 100vh; width: 100vw; background: var(--bg-app); overflow: hidden; }
        @media (max-width: 900px) { .mobile-view { display: flex; } }

        .m-header { padding: 12px 16px; background: rgba(8, 8, 11, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .m-title { font-size: 1rem; font-weight: 800; letter-spacing: -0.5px; color: var(--text-main); }
        .m-menu-btn { background: transparent; border: 1px solid var(--glass-border); color: white; font-size: 1.2rem; width: 36px; height: 36px; border-radius: 8px; display: grid; place-items: center; transition: var(--transition-fast); }
        .m-menu-btn:hover { background: rgba(255,255,255,0.1); }

        .m-tabs { display: flex; background: transparent; padding: 8px; gap: 5px; overflow-x: auto; }
        .m-tab { flex: 1; min-width: 80px; padding: 8px; text-align: center; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid transparent; transition: var(--transition-fast); }
        .m-tab.active { color: white; background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.15); transform: scale(1.02); }

        .m-filter-bar { padding: 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border); display: none; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .m-filter-row { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 5px; }
        .m-filter-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.03); color: #aaa; font-size: 0.65rem; font-weight: 700; cursor: pointer; transition: var(--transition-fast); }
        .m-filter-btn.active { background: rgba(255,255,255,0.15); color: white; border-color: var(--market-color); }
        .m-search-input { width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; margin-top: 5px; }

        .m-content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 80px; }
        .m-card { margin-bottom: 10px; padding: 12px; }
        .m-card-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 8px; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 6px; }
        .m-val { text-align: center; }
        .m-val span { display: block; font-size: 0.5rem; color: #888; text-transform: uppercase; font-weight: 700; }
        .m-val strong { font-family: monospace; font-size: 0.9rem; color: #fff; }
        .m-dmnd { margin-top: 6px; padding: 3px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; border: 1px solid transparent; text-align: center; }
        
        .m-actions { display: flex; gap: 6px; margin-top: 10px; }
        .m-btn { flex: 1; padding: 8px; border: 1px solid var(--glass-border); border-radius: 6px; font-weight: 700; font-size: 0.7rem; cursor: pointer; background: rgba(255,255,255,0.05); color: #ddd; transition: var(--transition-fast); }
        .m-btn-copy { color: var(--market-color); border-color: rgba(0,212,255,0.3); background: rgba(0,212,255,0.05); }
        .m-btn-del { color: var(--danger); border-color: rgba(255,71,87,0.3); background: rgba(255,71,87,0.05); }
        .m-btn:hover { transform: scale(1.03); background: rgba(255,255,255,0.1); }
        
        .m-seller { font-size: 0.65rem; font-family: monospace; color: var(--market-color); margin-top: 4px; opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .m-timer { font-size: 0.6rem; color: #666; text-align: center; margin-top: 4px; }

        /* Mobile FABs */
        .m-actions-bar { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 50; }
        .m-fab { 
            width: 52px; height: 52px; border-radius: 14px; border: none; font-size: 1.3rem; font-weight: 800; 
            cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; 
            transition: var(--transition-fast); backdrop-filter: blur(5px);
        }
        .m-fab.search { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .m-fab.list { background: linear-gradient(135deg, var(--market-color), #0099cc); color: #000; }
        .m-fab:active { transform: scale(0.9); }
        
        /* --- MODALS & DRAWER --- */
        /* Glass Overlay */
        .modal-overlay, .m-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); 
            display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open, .m-overlay.open { display: flex; opacity: 1; }

        /* Modern Modal */
        .modal { 
            width: 90%; max-width: 420px; background: #121216; border: 1px solid var(--glass-border); 
            border-radius: 16px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            transform: scale(0.95); transition: var(--transition-smooth); display: flex; flex-direction: column; gap: 15px;
        }
        .modal-overlay.open .modal { transform: scale(1); }

        .modal h2 { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; color: white; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .trust-box { background: rgba(46, 213, 115, 0.1); border: 1px solid rgba(46, 213, 115, 0.3); padding: 10px; border-radius: 8px; font-size: 0.8rem; color: var(--success); font-weight: 600; }
        
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; color: var(--text-muted); }
        .form-group input, .form-group select { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); color: white; 
            padding: 10px; border-radius: 8px; outline: none; font-size: 0.9rem; transition: var(--transition-fast); 
        }
        .form-group input:focus, .form-group select:focus { border-color: var(--market-color); background: rgba(255,255,255,0.06); }
        
        .checkbox-group { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .checkbox-group input { accent-color: var(--market-color); width: 16px; height: 16px; }
        
        .error-msg { min-height: 18px; font-size: 0.75rem; color: var(--danger); font-weight: 600; text-align: right; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 5px; }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: var(--transition-fast); }
        .btn-primary { background: linear-gradient(135deg, var(--market-color), #0088bb); color: #000; box-shadow: 0 4px 12px rgba(0,212,255,0.3); }
        .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-secondary { background: rgba(255,255,255,0.05); color: #ddd; border: 1px solid var(--glass-border); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }

        /* Drawer */
        .m-drawer { 
            position: fixed; top: 0; left: -320px; width: 280px; height: 100vh; background: #0e0e12; 
            z-index: 150; transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); border-right: 1px solid var(--glass-border); 
            padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
        }
        .m-drawer.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .m-drawer-close { align-self: flex-end; background: rgba(255,255,255,0.05); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .m-drawer-header { font-size: 1.2rem; font-weight: 800; color: var(--market-color); }
        .m-drawer-section { border-top: 1px solid var(--glass-border); padding-top: 15px; }
        .m-drawer-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 10px; font-weight: 700; }
        .m-drawer-info { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; font-size: 0.8rem; color: #ccc; }
        .m-drawer-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .m-drawer-btn { display: block; width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; margin-bottom: 6px; border-radius: 8px; text-align: left; font-weight: 600; cursor: pointer; transition: var(--transition-fast); }
        .m-drawer-btn:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .m-drawer-btn.active { background: var(--market-color); color: #000; border-color: var(--market-color); }
        .m-drawer-btn.discord { background: #5865F2; border-color: #5865F2; text-align: center; font-weight: 700; }
        .m-drawer-btn.key { background: rgba(255,255,255,0.05); color: var(--market-color); border: 1px solid var(--market-color); text-align: center; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #444; font-weight: 600; letter-spacing: 1px; }
    </style>
</head>
<body>

    <!-- DESKTOP UI -->
    <div class="desktop-view" id="desktopUI">
        <aside class="d-sidebar">
            <div class="d-sb-header">
                <span class="d-title">CLEEs List</span>
                <span class="d-badge">Verified System</span>
                <a href="https://discord.gg/Xq6qNSFw" target="_blank" class="d-discord">
                    <span>Join Discord</span>
                </a>
            </div>
            
            <div class="d-status" id="dStatusBox">
                <div class="d-status-row">
                    <span>Access</span> 
                    <span><span id="dType">Free</span> <span class="d-premium">PREMIUM</span></span>
                </div>
                <div class="d-status-row"><span>Slots</span> <span id="dSlots">1</span></div>
                <div class="d-status-row"><span>Limit</span> <span id="dLimit">3h</span></div>
            </div>

            <button class="d-key-btn" onclick="openKeyModal()">Verify / Add Key</button>
            
            <div class="d-help">
                ‚Ä¢ <b>Standard:</b> 1 Slot / 3h.<br>
                ‚Ä¢ <b>Normal Key:</b> 10 Slots / 12h + Lock Name.<br>
                ‚Ä¢ <b>Admin:</b> 99 Slots / 48h.<br>
                ‚Ä¢ Automatic cleanup enabled.
            </div>

            <div style="margin-top:15px; font-size:0.7rem; color:#666; font-weight:800; text-transform:uppercase;">Categories</div>
            <ul class="d-egg-list" id="dEggList"></ul>
        </aside>
        
        <main class="d-main">
            <header class="d-top-bar">
                <div class="d-tabs">
                    <button class="d-tab active" onclick="switchTab('values', 'desktop')">Values</button>
                    <button class="d-tab" onclick="switchTab('market', 'desktop')">Market</button>
                    <button class="d-tab" onclick="switchTab('my', 'desktop')">My List</button>
                </div>
                <div class="d-controls" id="dControls">
                    <input type="text" class="d-input" id="dSearch" placeholder="Search..." onkeyup="handleSearch('desktop')">
                    <select class="d-input" id="dSort" onchange="handleSort('desktop')">
                        <option value="newest">Newest</option>
                        <option value="price-asc">Low-High</option>
                        <option value="price-desc">High-Low</option>
                    </select>
                    <button class="d-btn" onclick="openModal()">+ Add Listing</button>
                </div>
            </header>
            
            <div class="d-filter-bar" id="dFilterBar">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <span style="color:#888; font-size:0.7rem; font-weight:700; text-transform:uppercase;">Rarity:</span>
                    <button class="d-filter-btn active" data-filter="all" onclick="setRarity('all', 'desktop')">All</button>
                    <button class="d-filter-btn" data-filter="Secret" onclick="setRarity('Secret', 'desktop')">Secret</button>
                    <button class="d-filter-btn" data-filter="Mythical" onclick="setRarity('Mythical', 'desktop')">Myth</button>
                    <button class="d-filter-btn" data-filter="Legendary" onclick="setRarity('Legendary', 'desktop')">Leg</button>
                    <div style="width:1px; height:16px; background:rgba(255,255,255,0.1); margin:0 5px;"></div>
                    <span style="color:#888; font-size:0.7rem; font-weight:700; text-transform:uppercase;">Var:</span>
                    <button class="d-filter-btn active" data-variant="All" onclick="setVariant('All', 'desktop')">All</button>
                    <button class="d-filter-btn" data-variant="Golden" onclick="setVariant('Golden', 'desktop')">Gold</button>
                    <button class="d-filter-btn" data-variant="Rainbow" onclick="setVariant('Rainbow', 'desktop')">Rain</button>
                </div>
            </div>

            <div class="d-content" id="dContentArea"></div>
        </main>
    </div>

    <!-- MOBILE UI -->
    <div class="mobile-view" id="mobileUI">
        <div class="m-header">
            <span class="m-title">CLEEs Value</span>
            <button class="m-menu-btn" onclick="toggleDrawer(true)">‚ò∞</button>
        </div>

        <div class="m-tabs">
            <button class="m-tab active" onclick="switchTab('values', 'mobile')">Values</button>
            <button class="m-tab" onclick="switchTab('market', 'mobile')">Market</button>
            <button class="m-tab" onclick="switchTab('my', 'mobile')">My List</button>
        </div>

        <div class="m-filter-bar" id="mFilterBar">
            <input type="text" class="m-search-input" id="mSearch" placeholder="Search..." onkeyup="handleSearch('mobile')">
            <div class="m-filter-row">
                <button class="m-filter-btn active" data-filter="all" onclick="setRarity('all', 'mobile')">All</button>
                <button class="m-filter-btn" data-filter="Secret" onclick="setRarity('Secret', 'mobile')">Sec</button>
                <button class="m-filter-btn" data-filter="Mythical" onclick="setRarity('Mythical', 'mobile')">Myth</button>
                <button class="m-filter-btn" data-filter="Legendary" onclick="setRarity('Legendary', 'mobile')">Leg</button>
            </div>
            <div class="m-filter-row">
                <button class="m-filter-btn" onclick="setSortMobile('newest')">New</button>
                <button class="m-filter-btn" onclick="setSortMobile('price-asc')">Low</button>
                <button class="m-filter-btn" onclick="setSortMobile('price-desc')">High</button>
            </div>
        </div>

        <div class="m-content" id="mContentArea"></div>

        <div class="m-actions-bar">
            <button class="m-fab search" onclick="toggleFilters()">üîç</button>
            <button class="m-fab list" onclick="openModal()">+</button>
        </div>

        <div class="m-overlay" id="mOverlay" onclick="toggleDrawer(false)"></div>
        <div class="m-drawer" id="mDrawer">
            <button class="m-drawer-close" onclick="toggleDrawer(false)">‚úï</button>
            <div class="m-drawer-header">Menu</div>
            
            <div class="m-drawer-section">
                <div class="m-drawer-title">User Status</div>
                <div class="m-drawer-info">
                    <div class="m-drawer-row"><span>Type:</span> <span id="mType">Free</span></div>
                    <div class="m-drawer-row"><span>Slots:</span> <span id="mSlots">1</span></div>
                    <div class="m-drawer-row"><span>Duration:</span> <span id="mDuration">3h</span></div>
                </div>
                <button class="m-drawer-btn key" onclick="openKeyModal()">Verify / Add Key</button>
            </div>

            <div class="m-drawer-section">
                <div class="m-drawer-title">Categories</div>
                <div id="mEggList" style="display: flex; flex-direction: column; gap: 5px;"></div>
            </div>

            <div class="m-drawer-section">
                <button class="m-drawer-btn discord" onclick="window.open('https://discord.gg/Xq6qNSFw', '_blank')">Join Discord</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="sellModal">
        <div class="modal">
            <h2>Create Listing</h2>
            <div class="trust-box" id="modalTrustText">Standard Access: Random names allowed.</div>
            <form id="sellForm" onsubmit="submitListing(event)">
                <div class="form-group">
                    <label>Pet Name</label>
                    <input type="text" id="pName" list="petList" placeholder="e.g. 2026 Overload" required>
                </div>
                <div class="form-group" style="flex-direction: row; gap: 10px;">
                    <div style="flex:1;">
                        <label>Rarity</label>
                        <select id="pRarity"><option>Secret</option><option>Mythical</option><option>Legendary</option></select>
                    </div>
                    <div style="flex:1;">
                        <label>Variant</label>
                        <select id="pVariant"><option>Normal</option><option>Golden</option><option>Rainbow</option></select>
                    </div>
                </div>
                <div class="form-group" style="flex-direction: row; gap: 10px;">
                    <div style="flex:1;">
                        <label>Amount</label>
                        <input type="number" id="pAmount" value="1" required>
                    </div>
                    <div style="flex:1;">
                        <label>Price</label>
                        <input type="number" id="pPrice" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Discord Name</label>
                    <input type="text" id="pDiscord" placeholder="User#1234" required>
                    <div id="discordStatus" style="font-size:0.7rem; height:14px; color:var(--market-color); font-weight:600;"></div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pNegotiable">
                    <label style="font-size:0.85rem; color:#ddd;">Allow Negotiation</label>
                </div>
                <div class="error-msg" id="errorMsg"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">List Pet</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="keyModal">
        <div class="modal">
            <h2>Access Verification</h2>
            <div class="form-group">
                <label>User ID</label>
                <input type="text" id="userIdInput" placeholder="YourDiscord#1234">
            </div>
            <div class="form-group">
                <label>Access Key</label>
                <input type="text" id="userKeyInput" placeholder="Paste key here">
            </div>
            <div style="font-size:0.7rem; color:#666; margin-top:5px;">Admin Key: <b>CLEE</b></div>
            <div class="modal-actions" style="margin-top:15px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="activateKey()">Activate</button>
            </div>
            <div class="error-msg" id="keyError" style="text-align: center; margin-top: 5px;"></div>
        </div>
    </div>

    <datalist id="petList"></datalist>

    <script>
        // --- CONFIGURATION ---
        const adminKey = "CLEE"; 
        const userKeys = [
            // ADD YOUR KEYS HERE:
            // { key: "YOUR_KEY_HERE", owner: "DiscordUser#1234" }
        ];

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAeTqBRr3_67LUY8_ARHOyvG1vmPo-fY0Q",
            authDomain: "clees-value1.firebaseapp.com",
            projectId: "clees-value1",
            storageBucket: "clees-value1.firebasestorage.app",
            messagingSenderId: "448532949070",
            appId: "1:448532949070:web:d3f8c0bbbc71ec326efb1f"
        };

        let db = null;
        if (firebaseConfig.projectId && firebaseConfig.projectId.length > 5) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
            } catch (e) { console.error("Firebase Error:", e); }
        }

        // --- PET DATA ---
        const PETS_DB = {
            "New Year Egg": {
                "Secret": [{ name: "2026 Overload", prices: { normal: 1200, golden: 500, rainbow: 5500 }, demand: "High" }, { name: "New Year Dragon", prices: { normal: 500, golden: 1800, rainbow: 2000 }, demand: "High" }, { name: "2026 Balloons", prices: { normal: 100, golden: 400, rainbow: 450 }, demand: "High" }],
                "Mythical": [{ name: "Starshine Warrior", prices: { normal: 2, golden: 8, rainbow: 12 }, demand: "Medium" }],
                "Legendary": [{ name: "Mr. Sprinkler", prices: { normal: "N.A.", golden: 1, rainbow: 2 }, demand: "Low" }]
            },
            "Christmas Egg": {
                "Secret": [{ name: "Gilded Seraphim", prices: { normal: 1000, golden: 3700, rainbow: 4200 }, demand: "High" }, { name: "Frost Spirit", prices: { normal: 50, golden: 160, rainbow: 220 }, demand: "Medium" }, { name: "Christmas Tree", prices: { normal: 120, golden: 500, rainbow: 600 }, demand: "Medium" }],
                "Mythical": [{ name: "Nutcracker", prices: { normal: "N.A.", golden: "N.A.", rainbow: "~1" }, demand: "Low" }],
                "Legendary": [{ name: "Ornament", prices: { normal: "N.A.", golden: "N.A.", rainbow: "N.A." }, demand: "Dead" }]
            },
            "Space Egg": {
                "Secret": [{ name: "Luminary Star", prices: { normal: 100, golden: 490, rainbow: 500 }, demand: "Medium" }, { name: "Cosmic Chaos", prices: { normal: 480, golden: 2050, rainbow: 2200 }, demand: "High" }],
                "Mythical": [{ name: "UFO Alien", prices: { normal: "N.A.", golden: 1, rainbow: 2 }, demand: "Low" }],
                "Legendary": [{ name: "Stellar Eye", prices: { normal: "N.A.", golden: "N.A.", rainbow: "N.A." }, demand: "Dead" }]
            },
            "5M Egg": {
                "Secret": [{ name: "5M Frost Monarch", prices: { normal: 1150, golden: 4500, rainbow: 5000 }, demand: "High" }, { name: "5M North Star", prices: { normal: 250, golden: 800, rainbow: 1200 }, demand: "Medium" }, { name: "Frosty Snowman", prices: { normal: 100, golden: 400, rainbow: 450 }, demand: "Medium" }]
            },
            "Special Pets": {
                "Secret": [{ name: "2026 Star", prices: { normal: 1100, golden: 4200, rainbow: 4730 }, demand: "High" }, { name: "Disco Lord", prices: { normal: 1400, golden: 5600, rainbow: 6300 }, demand: "High" }, { name: "Hooded Krampus", prices: { normal: 460, golden: 1600, rainbow: 2000 }, demand: "High" }, { name: "Celestial Candycane", prices: { normal: 900, golden: 3100, rainbow: 4000 }, demand: "High" }]
            },
            "Leaderboard": {
                "Secret": [{ name: "TOP 10", prices: { normal: 12000, golden: "O/C", rainbow: "O/C" }, demand: "High" }, { name: "TOP 100", prices: { normal: 1300, golden: 4000, rainbow: 4800 }, demand: "High" }, { name: "TOP 250", prices: { normal: 550, golden: 1900, rainbow: 2500 }, demand: "Medium" }]
            }
        };

        const customDemands = {
            "2026 Balloons": "High", "2026 Overload": "High", "New Year Dragon": "High", "Starshine Warrior": "Medium", "Mr. Sprinkler": "Low",
            "Frost Spirit": "Medium", "Gilded Seraphim": "High", "Christmas Tree": "Medium", "Nutcracker": "Low", "Ornament": "Dead",
            "Luminary Star": "Medium", "Cosmic Chaos": "High", "UFO Alien": "Low", "Stellar Eye": "Dead",
            "5M Frost Monarch": "High", "5M North Star": "Medium", "Frosty Snowman": "Medium",
            "2026 Star": "High", "Disco Lord": "High", "Hooded Krampus": "High", "Celestial Candycane": "High",
            "TOP 10": "High", "TOP 100": "High", "TOP 250": "Medium"
        };

        // --- STATE MANAGEMENT ---
        let appState = {
            tab: 'values',
            egg: 'New Year Egg',
            search: '',
            rarity: 'all',
            variant: 'all',
            sort: 'newest',
            platform: 'desktop',
            data: [],
            user: { type: 'free', key: null, owner: null, expiry: 0 } // type: free, normal, admin
        };

        // --- INITIALIZATION ---
        function init() {
            loadSession();
            populateDatalist();
            renderEggs();
            handleResize();
            if (db) {
                startAutoCleanup();
                fetchMarketData();
            }
            window.addEventListener('resize', handleResize);
        }

        function loadSession() {
            const raw = localStorage.getItem('clees_session_v2');
            if (raw) {
                const s = JSON.parse(raw);
                if (Date.now() < s.expiry) {
                    appState.user = s;
                } else {
                    localStorage.removeItem('clees_session_v2');
                    appState.user = { type: 'free', key: null, owner: null, expiry: 0 };
                }
            }
            updateUIUserStatus();
        }

        function saveSession(type, key, owner) {
            const durationDays = type === 'admin' ? 365 : 30; // Session validity (not listing validity)
            const session = {
                type: type,
                key: key,
                owner: owner,
                expiry: Date.now() + (durationDays * 86400000)
            };
            localStorage.setItem('clees_session_v2', JSON.stringify(session));
            appState.user = session;
            updateUIUserStatus();
        }

        function updateUIUserStatus() {
            const u = appState.user;
            let slots = 1, limit = "3h", typeLabel = "Free";
            
            if (u.type === 'normal') { slots = 10; limit = "12h"; typeLabel = "Normal"; }
            else if (u.type === 'admin') { slots = 99; limit = "48h"; typeLabel = "Admin"; }

            // Desktop
            safeSetHTML('dType', typeLabel);
            safeSetHTML('dSlots', slots);
            safeSetHTML('dLimit', limit);
            const prem = document.querySelector('.d-premium');
            if (prem) prem.style.display = u.type !== 'free' ? 'inline' : 'none';

            // Mobile
            safeSetHTML('mType', typeLabel);
            safeSetHTML('mSlots', slots);
            safeSetHTML('mDuration', limit);
        }

        function safeSetHTML(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function handleResize() {
            const isDesktop = window.innerWidth > 900;
            const newPlatform = isDesktop ? 'desktop' : 'mobile';
            if (appState.platform !== newPlatform) {
                appState.platform = newPlatform;
                document.querySelector('.desktop-view').style.display = isDesktop ? 'flex' : 'none';
                document.querySelector('.mobile-view').style.display = isDesktop ? 'none' : 'flex';
                switchTab(appState.tab, newPlatform);
            }
        }

        function populateDatalist() {
            const dl = document.getElementById('petList');
            dl.innerHTML = '';
            const allNames = new Set();
            Object.keys(PETS_DB).forEach(egg => {
                Object.keys(PETS_DB[egg]).forEach(cat => PETS_DB[egg][cat].forEach(p => allNames.add(p.name)));
            });
            allNames.forEach(name => { const opt = document.createElement('option'); opt.value = name; dl.appendChild(opt); });
        }

        function renderEggs() {
            const dHtml = Object.keys(PETS_DB).map(egg => 
                `<li class="d-egg-item ${appState.egg === egg ? 'active' : ''}" onclick="selectEgg('${egg}', 'desktop')">${egg}</li>`
            ).join('');
            document.getElementById('dEggList').innerHTML = dHtml;

            const mHtml = Object.keys(PETS_DB).map(egg => 
                `<button class="m-drawer-btn ${appState.egg === egg ? 'active' : ''}" onclick="selectEgg('${egg}', 'mobile')">${egg}</button>`
            ).join('');
            document.getElementById('mEggList').innerHTML = mHtml;
        }

        function switchTab(tab, platform) {
            appState.tab = tab;
            appState.search = ''; appState.rarity = 'all'; appState.variant = 'all'; appState.sort = 'newest';
            
            // UI State
            const tabs = document.querySelectorAll(platform === 'desktop' ? '.d-tab' : '.m-tab');
            tabs.forEach(t => t.classList.remove('active'));
            const index = tab === 'values' ? 0 : tab === 'market' ? 1 : 2;
            if (tabs[index]) tabs[index].classList.add('active');

            const filterBar = platform === 'desktop' ? document.getElementById('dFilterBar') : document.getElementById('mFilterBar');
            filterBar.style.display = (tab === 'values') ? 'none' : (platform === 'desktop' ? 'flex' : 'block');

            const searchInput = document.getElementById(platform === 'desktop' ? 'dSearch' : 'mSearch');
            if (searchInput) searchInput.value = '';

            if (tab === 'values') renderValues();
            else fetchMarketData();
        }

        function selectEgg(egg, platform) {
            appState.egg = egg;
            renderEggs();
            if (appState.tab === 'values') renderValues();
            if (platform === 'mobile') toggleDrawer(false);
        }

        function toggleFilters() {
            const bar = document.getElementById('mFilterBar');
            bar.style.display = bar.style.display === 'block' ? 'none' : 'block';
        }

        function toggleDrawer(open) {
            const d = document.getElementById('mDrawer');
            const o = document.getElementById('mOverlay');
            if (open) { d.classList.add('open'); o.classList.add('open'); }
            else { d.classList.remove('open'); o.classList.remove('open'); }
        }

        function handleSearch(platform) {
            const val = platform === 'desktop' ? document.getElementById('dSearch').value : document.getElementById('mSearch').value;
            appState.search = val.toLowerCase();
            if (appState.tab === 'values') renderValues(); else renderMarket();
        }

        function handleSort(platform) { appState.sort = document.getElementById('dSort').value; if (appState.tab !== 'values') renderMarket(); }
        function setSortMobile(val) { appState.sort = val; if (appState.tab !== 'values') renderMarket(); }

        function setRarity(val, platform) {
            appState.rarity = val;
            updateFilterButtons(platform);
            if (appState.tab === 'values') renderValues(); else renderMarket();
        }

        function setVariant(val, platform) {
            appState.variant = val.toLowerCase();
            updateFilterButtons(platform);
            if (appState.tab === 'values') renderValues(); else renderMarket();
        }

        function updateFilterButtons(platform) {
            const context = platform === 'desktop' ? '#dFilterBar ' : '';
            document.querySelectorAll(`${context}.d-filter-btn, ${context}.m-filter-btn`).forEach(btn => {
                if (btn.dataset.filter) btn.classList.toggle('active', btn.dataset.filter === appState.rarity);
                if (btn.dataset.variant) {
                    let v = btn.dataset.variant.toLowerCase();
                    btn.classList.toggle('active', v === 'all' ? appState.variant === 'all' : v === appState.variant);
                }
            });
        }

        // --- RENDERERS ---
        function renderValues() {
            const container = appState.platform === 'desktop' ? document.getElementById('dContentArea') : document.getElementById('mContentArea');
            const data = PETS_DB[appState.egg];
            if (!data) { container.innerHTML = '<div class="empty-state">No Category</div>'; return; }

            let html = '';
            const rarities = ['Secret', 'Mythical', 'Legendary'];

            rarities.forEach(rarity => {
                if (!data[rarity]) return;
                let pets = data[rarity].filter(p => {
                    if (appState.search && !p.name.toLowerCase().includes(appState.search)) return false;
                    if (appState.rarity !== 'all' && rarity !== appState.rarity) return false;
                    return true;
                });

                if (pets.length > 0) {
                    if (appState.platform === 'desktop') {
                        html += `<div style="margin-bottom:15px; color:var(--text-muted); font-weight:800; font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">${rarity}</div>`;
                        html += `<div class="d-grid">`;
                        pets.forEach(p => {
                            const dmnd = customDemands[p.name] || "";
                            html += `
                                <div class="d-card rarity-${rarity}">
                                    <div class="d-card-header">
                                        <span>${p.name}</span>
                                        <span class="d-card-badge">Values</span>
                                    </div>
                                    ${dmnd ? `<div class="d-demand ${dmnd}">${dmnd}</div>` : ''}
                                    <div class="d-price-row">
                                        <div class="d-price-box">
                                            <span class="d-price-label">Normal</span>
                                            <span class="d-price-val">${p.prices.normal}</span>
                                        </div>
                                        <div class="d-price-box">
                                            <span class="d-price-label">Golden</span>
                                            <span class="d-price-val">${p.prices.golden}</span>
                                        </div>
                                        <div class="d-price-box">
                                            <span class="d-price-label">Rainbow</span>
                                            <span class="d-price-val">${p.prices.rainbow}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        pets.forEach(p => {
                            const dmnd = customDemands[p.name] || "";
                            const dmndClass = dmnd ? `dmnd-${dmnd}` : '';
                            html += `
                                <div class="m-card" data-rarity="${rarity}">
                                    <div class="m-card-header">
                                        <span>${p.name}</span>
                                        <span class="m-card-badge">${rarity}</span>
                                    </div>
                                    ${dmnd ? `<div class="m-dmnd ${dmndClass}">${dmnd}</div>` : ''}
                                    <div class="m-card-grid">
                                        <div class="m-val"><span>N</span><strong>${p.prices.normal}</strong></div>
                                        <div class="m-val"><span>G</span><strong>${p.prices.golden}</strong></div>
                                        <div class="m-val"><span>R</span><strong>${p.prices.rainbow}</strong></div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }
            });

            if (html === '') html = '<div class="empty-state">No match found.</div>';
            container.innerHTML = html;
        }

        function fetchMarketData() {
            const container = appState.platform === 'desktop' ? document.getElementById('dContentArea') : document.getElementById('mContentArea');
            if (!db) { container.innerHTML = '<div class="empty-state">Database offline</div>'; return; }
            container.innerHTML = '<div class="empty-state" style="color:var(--market-color);">Loading...</div>';
            
            db.collection('market_listings').get().then(snap => {
                appState.data = [];
                snap.forEach(doc => appState.data.push({ id: doc.id, ...doc.data() }));
                renderMarket();
            }).catch(err => {
                container.innerHTML = '<div class="empty-state">Error loading data.</div>';
            });
        }

        function formatTime(ms) {
            if (ms < 0) return "Expired";
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            return `${h}h ${m}m`;
        }

        function renderMarket() {
            const container = appState.platform === 'desktop' ? document.getElementById('dContentArea') : document.getElementById('mContentArea');
            const myId = localStorage.getItem('tapping_user_id');
            
            let filtered = appState.data.filter(item => {
                if (appState.search && !item.name.toLowerCase().includes(appState.search) && !item.discord.toLowerCase().includes(appState.search)) return false;
                if (appState.rarity !== 'all' && item.rarity !== appState.rarity) return false;
                if (appState.variant !== 'all' && item.variant.toLowerCase() !== appState.variant) return false;
                if (appState.tab === 'my' && item.userId !== myId) return false;
                return true;
            });

            if (appState.sort === 'price-asc') filtered.sort((a, b) => a.price - b.price);
            if (appState.sort === 'price-desc') filtered.sort((a, b) => b.price - a.price);
            if (appState.sort === 'newest') filtered.reverse();

            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state">No listings found.</div>'; return; }

            let html = '';
            if (appState.platform === 'desktop') {
                html += '<div class="d-grid">';
                filtered.forEach(item => {
                    const isMine = item.userId === myId;
                    const dmnd = customDemands[item.name] || "";
                    const expires = formatTime(item.expiresAt - Date.now());
                    
                    html += `
                        <div class="d-card d-mkt-card rarity-${item.rarity}">
                            <div class="d-card-header">
                                <span>${item.name}</span>
                                <span class="d-card-badge">${item.variant}</span>
                            </div>
                            ${dmnd ? `<div class="d-demand ${dmnd}">${dmnd}</div>` : ''}
                            <div class="d-mkt-stats">
                                <div class="d-mkt-stat price"><span>Price</span><strong>${item.price.toLocaleString()}</strong></div>
                                <div class="d-mkt-stat"><span>Amt</span><strong>${item.amount || 1}</strong></div>
                                <div class="d-mkt-stat"><span>Rarity</span><strong>${item.rarity ? item.rarity.substr(0,1) : '-'}</strong></div>
                            </div>
                            ${item.negotiable ? '<div class="d-neg">Negotiable</div>' : ''}
                            <div class="d-timer">‚è±Ô∏è ${expires}</div>
                            <div class="d-mkt-footer">
                                <div class="d-seller">${item.discord}</div>
                                <div class="d-acts">
                                    <button class="d-act-btn" onclick="copyText('${item.discord}')">Copy</button>
                                    ${isMine ? `<button class="d-act-btn d-act-del" onclick="deleteListing('${item.id}')">Del</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                filtered.forEach(item => {
                    const isMine = item.userId === myId;
                    const dmnd = customDemands[item.name] || "";
                    const dmndClass = dmnd ? `dmnd-${dmnd}` : '';
                    const expires = formatTime(item.expiresAt - Date.now());
                    html += `
                        <div class="m-card" data-rarity="${item.rarity}">
                            <div class="m-card-header">
                                <span>${item.name}</span>
                                <span class="m-card-badge">${item.variant}</span>
                            </div>
                            ${dmnd ? `<div class="m-dmnd ${dmndClass}">${dmnd}</div>` : ''}
                            <div class="m-card-grid">
                                <div class="m-val"><span>Price</span><strong>${item.price.toLocaleString()}</strong></div>
                                <div class="m-val"><span>Amt</span><strong>${item.amount || 1}</strong></div>
                                <div class="m-val"><span>Rarity</span><strong>${item.rarity ? item.rarity.substr(0,1) : '-'}</strong></div>
                            </div>
                            ${item.negotiable ? '<div style="font-size:0.7rem; color:var(--premium); margin-top:5px; text-align:center; font-weight:700;">Negotiable</div>' : ''}
                            <div class="m-timer">‚è±Ô∏è ${expires}</div>
                            <div class="m-seller">${item.discord}</div>
                            <div class="m-actions">
                                <button class="m-btn m-btn-copy" onclick="copyText('${item.discord}')">Copy</button>
                                ${isMine ? `<button class="m-btn m-btn-del" onclick="deleteListing('${item.id}')">Del</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        // --- MODALS & ACTIONS ---
        function openModal() {
            const u = appState.user;
            const userId = localStorage.getItem('tapping_user_id') || ('usr_' + Math.random().toString(36).substr(2,9));
            localStorage.setItem('tapping_user_id', userId);

            if (!db) { alert("Database connection required."); return; }

            // Count active listings
            db.collection('market_listings').where('userId', '==', userId).get().then(snap => {
                let active = 0;
                const now = Date.now();
                snap.forEach(doc => {
                    if (doc.data().expiresAt > now) active++;
                });

                // Limits
                let maxSlots = 1;
                if (u.type === 'normal') maxSlots = 10;
                if (u.type === 'admin') maxSlots = 99;

                if (active >= maxSlots) {
                    alert(`Limit Reached (${active}/${maxSlots}). Wait for item expiry.`);
                    return;
                }

                // Open Modal
                document.getElementById('sellModal').classList.add('open');
                document.getElementById('sellForm').reset();
                document.getElementById('errorMsg').innerText = "";
                document.getElementById('discordStatus').innerText = "";

                const dInput = document.getElementById('pDiscord');
                const trustText = document.getElementById('modalTrustText');

                // Form Logic based on User Type
                if (u.type === 'free') {
                    trustText.textContent = "üîì Standard: Random name allowed (3h duration).";
                    trustText.style.borderColor = "rgba(255,255,255,0.2)";
                    dInput.removeAttribute('readonly');
                    dInput.placeholder = "Enter Any Name";
                    dInput.value = "";
                } else if (u.type === 'normal') {
                    trustText.textContent = `üîí Key Locked: Name must be ${u.owner}`;
                    trustText.style.borderColor = "var(--market-color)";
                    dInput.setAttribute('readonly', 'readonly');
                    dInput.value = u.owner;
                    document.getElementById('discordStatus').innerText = "Verified Identity";
                } else {
                    trustText.textContent = "üîì Admin: Full access. Override enabled.";
                    trustText.style.borderColor = "var(--premium)";
                    dInput.removeAttribute('readonly');
                    dInput.placeholder = "Admin Override";
                    dInput.value = "";
                }
            });
        }

        function openKeyModal() { 
            toggleDrawer(false);
            document.getElementById('keyModal').classList.add('open'); 
            document.getElementById('keyError').innerText = ""; 
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
        }

        async function activateKey() {
            const uInput = document.getElementById('userIdInput').value.trim();
            const kInput = document.getElementById('userKeyInput').value.trim();
            const err = document.getElementById('keyError');
            
            if (!uInput || !kInput) return err.innerText = "Fill all fields.";

            // Admin Key
            if (kInput === adminKey) {
                saveSession('admin', kInput, null);
                closeModal();
                alert("Admin Access Granted (48h listings)");
                return;
            }

            // Normal Keys
            const match = userKeys.find(k => k.key === kInput);
            if (match) {
                if (uInput.toLowerCase() === match.owner.toLowerCase()) {
                    saveSession('normal', kInput, match.owner);
                    closeModal();
                    alert(`Key Validated: ${match.owner}`);
                } else {
                    err.innerText = `Key belongs to: ${match.owner}`;
                }
                return;
            }

            err.innerText = "Invalid Key";
        }

        async function submitListing(e) {
            e.preventDefault();
            const btn = e.target.querySelector('#submitBtn');
            const err = document.getElementById('errorMsg');
            
            const name = document.getElementById('pName').value.trim();
            const price = parseInt(document.getElementById('pPrice').value);
            const discord = document.getElementById('pDiscord').value.trim();
            
            if (!name || !price || !discord) { err.innerText = "Fill all fields"; return; }

            btn.disabled = true; btn.innerText = "Posting...";

            const userId = localStorage.getItem('tapping_user_id');
            const u = appState.user;

            // Determine Duration
            let durationMs = 3 * 3600000; // 3h default
            if (u.type === 'normal') durationMs = 12 * 3600000; // 12h
            if (u.type === 'admin') durationMs = 48 * 3600000; // 48h

            const data = {
                name: name,
                rarity: document.getElementById('pRarity').value,
                variant: document.getElementById('pVariant').value,
                amount: parseInt(document.getElementById('pAmount').value),
                price: price,
                discord: discord,
                negotiable: document.getElementById('pNegotiable').checked,
                userId: userId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: Date.now() + durationMs,
                userType: u.type // Used for cleanup tracking if needed
            };

            try {
                await db.collection('market_listings').add(data);
                closeModal();
                switchTab('my', appState.platform); // Go to My List to show it
            } catch (e) {
                err.innerText = "Error: " + e.message;
                btn.disabled = false; btn.innerText = "List Pet";
            }
        }

        async function deleteListing(id) {
            if (!confirm("Delete this listing?")) return;
            try { 
                await db.collection('market_listings').doc(id).delete(); 
                // Optimistic update
                appState.data = appState.data.filter(x => x.id !== id);
                renderMarket(); 
            } catch (e) { alert(e.message); }
        }

        function copyText(text) {
            navigator.clipboard.writeText(text);
            // Visual feedback could go here
        }

        // --- CLEANUP SYSTEM ---
        function startAutoCleanup() {
            if (!db) return;
            // Run every minute
            setInterval(() => {
                const now = Date.now();
                // Query for expired items
                db.collection('market_listings').where('expiresAt', '<', now).get().then(snap => {
                    if (snap.empty) return;
                    const batch = db.batch();
                    snap.forEach(doc => batch.delete(doc.ref));
                    batch.commit().then(() => {
                        // Refresh view if active
                        if (appState.tab !== 'values') fetchMarketData();
                    });
                });
            }, 60000);
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
